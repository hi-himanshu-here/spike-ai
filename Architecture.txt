# Spike AI Builder Hackathon - AI Backend System

A production-ready AI backend for answering natural-language questions about Google Analytics 4 (GA4) and SEO audit data using agent-based reasoning.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────┐
│                    API Layer (Port 8080)                 │
│                   POST /query endpoint                   │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                     Orchestrator                         │
│  - Intent Detection (Analytics/SEO/Both)                │
│  - Agent Routing & Task Decomposition                   │
│  - Response Aggregation                                 │
│  - Uses LiteLLM (gemini-2.5-flash) for reasoning        │
└──────────┬──────────────────────────┬───────────────────┘
           │                          │
           ▼                          ▼
┌──────────────────────┐   ┌──────────────────────────┐
│  Analytics Agent     │   │     SEO Agent            │
│  (Tier 1)            │   │     (Tier 2)             │
├──────────────────────┤   ├──────────────────────────┤
│ • GA4 Data API       │   │ • Google Sheets API      │
│ • credentials.json   │   │ • Screaming Frog data    │
│ • Property-agnostic  │   │ • Filtering & grouping   │
│ • Metric validation  │   │ • Schema-safe operations │
│ • Natural language   │   │ • JSON/Natural output    │
│   explanations       │   │                          │
└──────────────────────┘   └──────────────────────────┘
```

## System Components

### 1. API Layer
- **Endpoint**: `POST http://localhost:8080/query`
- **Port**: 8080 (required for evaluation)
- **Health Check**: `GET http://localhost:8080/health`

### 2. Orchestrator (`server/orchestrator.ts`)
Central decision-making layer that:
- Detects user intent using LiteLLM
- Routes queries to appropriate agents (Analytics, SEO, or Both)
- Decomposes complex multi-agent queries
- Aggregates responses from multiple agents
- Returns unified natural-language answers

### 3. Analytics Agent (`server/agents/analytics-agent.ts`)
Handles GA4 queries:
- Uses **Google Analytics Data API** (not static exports)
- Loads credentials from `credentials.json` at runtime
- Accepts dynamic `propertyId` from request body
- **Property-agnostic**: Works with any GA4 property after credential replacement
- Validates metrics/dimensions against allowlist
- Infers reporting plans from natural language using LiteLLM
- Returns structured data + explanations

**Allowlisted Metrics**:
- `activeUsers`, `sessions`, `screenPageViews`, `eventCount`, `conversions`, `totalRevenue`, `averageSessionDuration`, `bounceRate`, `engagementRate`, `newUsers`, `userEngagementDuration`, `sessionConversionRate`

**Allowlisted Dimensions**:
- `date`, `pagePath`, `pageTitle`, `country`, `city`, `deviceCategory`, `browser`, `operatingSystem`, `sessionSource`, `sessionMedium`, `sessionCampaignName`, `landingPage`, `eventName`

### 4. SEO Agent (`server/agents/seo-agent.ts`)
Handles SEO audit queries:
- Ingests data from **Google Sheets** (live, not static exports)
- Reads Screaming Frog exports via Google Sheets API
- Supports filtering, grouping, aggregation, conditional logic
- Schema-change safe (dynamic column detection)
- Returns JSON or natural language based on query

### 5. LiteLLM Client (`server/lib/litellm.ts`)
AI reasoning layer:
- Base URL: `http://3.110.18.218`
- Models: `gemini-2.5-flash`, `gemini-2.5-pro`, `gemini-3-pro-preview`
- Implements exponential backoff for 429 errors
- Loads API key from `LITELLM_API_KEY` environment variable

## Setup Instructions

### Prerequisites
- Node.js 20.x or higher
- Google Cloud project with GA4 Data API enabled
- Service account credentials with:
  - Google Analytics Data API access
  - Google Sheets API access (for SEO data)

### Installation

1. **Clone the repository**
```bash
git clone <repository-url>
cd <repository-name>
```

2. **Install dependencies**
```bash
npm install
```

3. **Configure credentials**

Create `credentials.json` at the project root:
```json
{
  "type": "service_account",
  "project_id": "your-project-id",
  "private_key_id": "...",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  "client_email": "your-service-account@your-project.iam.gserviceaccount.com",
  "client_id": "...",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "..."
}
```

4. **Set environment variables**
```bash
export LITELLM_API_KEY="your-litellm-api-key"
export SEO_SPREADSHEET_ID="your-google-sheets-id"  # Optional, can be in request
```

5. **Deploy using the script**
```bash
bash deploy.sh
```

The server will:
- Install dependencies
- Verify credentials.json exists
- Start on port 8080
- Run health check

### Manual Start

**Development**:
```bash
PORT=8080 npm run dev
```

**Production**:
```bash
npm run build
PORT=8080 npm start
```

## API Usage

### Request Format

**For GA4 queries** (propertyId required):
```json
POST http://localhost:8080/query
Content-Type: application/json

{
  "propertyId": "123456789",
  "query": "Give me a daily breakdown of page views for /pricing over the last 14 days"
}
```

**For SEO queries** (propertyId optional):
```json
{
  "query": "Which URLs do not use HTTPS and have title tags longer than 60 characters?",
  "spreadsheetId": "your-sheet-id"  // Optional if SEO_SPREADSHEET_ID is set
}
```

**For multi-agent queries**:
```json
{
  "propertyId": "123456789",
  "spreadsheetId": "your-sheet-id",
  "query": "What are the top 10 pages by views and what are their title tags?"
}
```

### Response Format

```json
{
  "success": true,
  "response": "Over the last 14 days, the /pricing page received...",
  "data": {
    "dimensionHeaders": [...],
    "metricHeaders": [...],
    "rows": [...]
  },
  "metadata": {
    "intent": "analytics",
    "agentsUsed": ["analytics"],
    "processingTime": 1234
  }
}
```

## Example Queries

### Tier 1 - Analytics Agent

```bash
curl -X POST http://localhost:8080/query \
  -H "Content-Type: application/json" \
  -d '{
    "propertyId": "123456789",
    "query": "What are the top 5 traffic sources driving users to the pricing page in the last 30 days?"
  }'
```

### Tier 2 - SEO Agent

```bash
curl -X POST http://localhost:8080/query \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Group all pages by indexability status and provide a count for each group"
  }'
```

### Tier 3 - Multi-Agent System

```bash
curl -X POST http://localhost:8080/query \
  -H "Content-Type: application/json" \
  -d '{
    "propertyId": "123456789",
    "query": "Which pages are in the top 20% by views but have missing meta descriptions?"
  }'
```

## Data Source Integrations

### Google Analytics 4
- **API**: Google Analytics Data API v1beta
- **Authentication**: Service account credentials (credentials.json)
- **Scope**: `https://www.googleapis.com/auth/analytics.readonly`
- **Runtime Loading**: Credentials loaded at startup, propertyId provided per request
- **Evaluator-Safe**: System works with replaced credentials.json and propertyId

### Google Sheets (SEO Data)
- **API**: Google Sheets API v4
- **Authentication**: Same service account as GA4
- **Scope**: `https://www.googleapis.com/auth/spreadsheets.readonly`
- **Data Source**: Screaming Frog exports shared with service account
- **Schema Handling**: Dynamic column detection for schema changes

### LiteLLM
- **Endpoint**: http://3.110.18.218/chat/completions
- **Models**: gemini-2.5-flash (default), gemini-2.5-pro, gemini-3-pro-preview
- **Authentication**: Bearer token (LITELLM_API_KEY)
- **Retry Logic**: Exponential backoff with 3 retries for 429 errors

## Assumptions & Limitations

### Assumptions
1. **GA4 Setup**: Participants have created their own GA4 property (may be empty)
2. **Credentials Format**: credentials.json follows standard Google service account format
3. **Spreadsheet Access**: SEO spreadsheet is shared with service account email
4. **Network Access**: Deployment environment can reach:
   - `analyticsdata.googleapis.com` (GA4 API)
   - `sheets.googleapis.com` (Sheets API)
   - `http://3.110.18.218` (LiteLLM proxy)
5. **Date Inference**: "Last N days" calculated from current date at query time
6. **JSON Parsing**: LLM responses contain valid JSON (with retry logic)

### Limitations
1. **Metric/Dimension Coverage**: Limited to allowlisted fields (extensible via code)
2. **GA4 Data Sparsity**: System handles empty datasets but cannot create traffic
3. **LLM Dependency**: Requires LiteLLM API key; falls back gracefully if unavailable
4. **Spreadsheet Schema**: Assumes first sheet contains SEO data
5. **No Authentication**: API has no auth layer (add via middleware if needed)
6. **Single Spreadsheet**: SEO agent supports one sheet at a time per query
7. **Processing Time**: Complex multi-agent queries may take 10-30 seconds

### Known Edge Cases
- **Empty GA4 Properties**: Returns valid response with "no data available" message
- **Missing Columns**: SEO agent skips filters for non-existent columns
- **Rate Limits**: LiteLLM implements backoff; GA4/Sheets have generous quotas
- **Malformed Queries**: Returns structured error with HTTP 400/500

## File Structure

```
.
├── server/
│   ├── agents/
│   │   ├── analytics-agent.ts    # GA4 integration
│   │   └── seo-agent.ts           # Google Sheets integration
│   ├── lib/
│   │   └── litellm.ts             # LiteLLM client
│   ├── orchestrator.ts            # Multi-agent orchestrator
│   ├── routes.ts                  # API routes
│   └── index.ts                   # Express server
├── credentials.json               # GA4/Sheets credentials (required)
├── deploy.sh                      # Deployment script
├── package.json                   # Dependencies
└── README.md                      # This file
```

## Testing

Run the test suite:
```bash
# Health check
curl http://localhost:8080/health

# Tier 1 test
curl -X POST http://localhost:8080/query \
  -H "Content-Type: application/json" \
  -d '{"propertyId": "123456789", "query": "Show me users and sessions for last 7 days"}'

# Tier 2 test
curl -X POST http://localhost:8080/query \
  -H "Content-Type: application/json" \
  -d '{"query": "How many pages are indexable?"}'

# Tier 3 test
curl -X POST http://localhost:8080/query \
  -H "Content-Type: application/json" \
  -d '{"propertyId": "123456789", "query": "Top 5 pages by views with their title tags in JSON"}'
```

## Deployment Checklist

- [ ] `credentials.json` exists at project root
- [ ] `LITELLM_API_KEY` environment variable set
- [ ] `SEO_SPREADSHEET_ID` environment variable set (or provided in requests)
- [ ] GA4 property ID available for testing
- [ ] Service account has Analytics Data API access
- [ ] Service account has Sheets API access
- [ ] Spreadsheet shared with service account email
- [ ] Port 8080 is accessible
- [ ] `deploy.sh` is executable

## Production Readiness

✅ **Error Handling**: Comprehensive try/catch with structured error responses  
✅ **Validation**: Zod schema validation for all API inputs  
✅ **Logging**: Timestamped logs with source attribution  
✅ **Retry Logic**: Exponential backoff for rate limits  
✅ **Graceful Degradation**: Returns meaningful errors when data unavailable  
✅ **Property-Agnostic**: Works with any GA4 property after credential swap  
✅ **Schema-Safe**: SEO agent handles dynamic spreadsheet schemas  
✅ **Extensibility**: Modular agent architecture for adding new domains  
✅ **Health Checks**: `/health` endpoint for monitoring  
✅ **Documentation**: Comprehensive setup and API documentation  

## Troubleshooting

**Server won't start**:
- Check Node.js version: `node --version` (should be 20.x)
- Verify credentials.json exists: `ls -la credentials.json`
- Check port 8080 is free: `lsof -i :8080`

**GA4 queries fail**:
- Verify service account has Analytics Data API access
- Check propertyId is correct (numeric, no "properties/" prefix)
- Ensure credentials.json is valid JSON

**SEO queries fail**:
- Verify spreadsheet is shared with service account email
- Check SEO_SPREADSHEET_ID is correct
- Ensure first sheet contains Screaming Frog data

**LiteLLM errors**:
- Verify LITELLM_API_KEY is set
- Check network access to http://3.110.18.218
- Review logs for 429 (rate limit) or 401 (invalid key) errors

## License

MIT

## Contact

For questions about this implementation, please contact the development team.
